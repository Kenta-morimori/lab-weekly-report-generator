# 研究室・週報生成 Web アプリケーション 要件定義

## 1. 概要

- 目的  
  - 研究室の週報を、所定の PDF フォーマット（「研究室・週報（XXXX年度）」）に沿って自動生成し、1枚の PDF として出力する Web アプリケーションを提供する。
- 対象ユーザー  
  - 研究室に所属する学生（複数人利用を想定）。
- 想定利用フロー  
  1. ユーザーが Web サイトを開く。
  2. 氏名・週の対象日・日々の滞在時間・研究内容・目標などを入力する。
  3. 「PDF出力」ボタンを押す。
  4. ブラウザから PDF ファイルがダウンロードされる。
  5. ユーザーが指定の Drive などへアップロードする（現状は手動運用）。

---

## 2. 週の扱い・日付ロジック

### 2.1 週の定義

- 1週間は **月曜〜日曜** を 1単位とする。
- 画面上でユーザーが選択するのは「前週に含まれる任意の日付（カレンダー入力）」とする。

### 2.2 前週・今週の決定

- ユーザーが選んだ日付 `D` について：
  - `D` を含む週の **月曜〜日曜** を「前週」とする。
  - 「前週」の翌週の **月曜〜日曜** を「今週」とする。
- 画面上には、前週・今週それぞれについて以下を自動表示する：
  - 週のラベル（例）  
    - 前週：`2025/04/07〜2025/04/13`  
    - 今週：`2025/04/14〜2025/04/20`
  - 各日付（例：`2025-04-07 (月)`〜`2025-04-13 (日)`）

### 2.3 年度の扱い

- タイトルに表示する年度は、基本的に「現在の日付に基づく年度」とする。
  - 例：2025年4月1日〜2026年3月31日を「2025年度」とする。
- 画面上で年度を自動入力し、必要であればユーザーが手動で修正可能とする（テキスト入力）。

### 2.4 提出日・ファイル名用日付

- **提出日**  
  - デフォルト値：上記「今週」の **月曜日の日付** を自動設定する。
  - 必要であればユーザーが手動で変更可能とする。
- **ファイル名に使う日付**
  - `週報_[氏名]_[今週月曜日の日付].pdf`
  - 日付の形式は `YYYY-MM-DD`（例：`2025-04-14`）。

---

## 3. 入力項目（画面仕様）

### 3.1 基本情報

- 氏名（必須）
  - テキスト入力。
  - デフォルトは空（複数人利用を想定するため）。
- 年度
  - テキスト入力。デフォルトは自動推定した年度。
- 週選択用日付（前週に含まれる任意の日付）
  - カレンダー（date picker）から 1 日を選択。
  - 選択に応じて前週／今週の週範囲・各日付を自動計算する。

### 3.2 日ごとの入力（前週・今週）

前週・今週それぞれについて、週 7 日分の行を自動生成する。

#### 3.2.1 日ごとの項目

各日について以下を入力する：

- 日付（自動表示・編集不可）
- 大学滞在開始時刻
  - 時刻入力（例：`09:00`）
- 大学滞在終了時刻
  - 時刻入力（例：`18:00`）
- 離席時間（合計）
  - 数値入力（分単位、例：`60` = 60分）
- 研究内容・行動・達成内容（自由記述）
  - テキストエリア（もしくは単一行テキストでも可だが、複数行入力を想定）
  - 入力指針（例）：  
    - 講義名・実験名・勉強会・論文読み・その他  
    - その日の主な行動・達成事項  
  - 文字数制限：**最大 200 文字程度**（初期値。後で調整可能）

#### 3.2.2 自動計算される値（1日分）

- 1日の大学滞在時間（分）
  - `滞在時間（分） = (終了時刻 − 開始時刻) − 離席時間（分）`
  - マイナスになった場合は 0 分として扱う。
  - 計算結果は画面上にも表示する（確認用）。
- 必要に応じて、`hh:mm` 形式への変換表示を行ってもよい（UI仕様）。

### 3.3 本文系項目（テキストエリア）

PDF上の「前週・今週」の上部・下部に記載されるテキストを入力する。

- 前週の研究達成目標
  - テキストエリア
  - 文字数制限：**最大 200 文字**（目安）
- 前週の目標達成度
  - テキストエリア
  - 文字数制限：200文字
- ●達成点
  - テキストエリア
  - 文字数制限：200文字
- ●課題・反省点
  - テキストエリア
  - 文字数制限：200文字
- 今週の研究達成目標
  - テキストエリア
  - 文字数制限：200文字
- 備考
  - テキストエリア
  - 文字数制限：200文字

> 備考：  
> - 文字数制限は PDF 1枚に収めるための初期設定であり、今後実際の出力を見ながら微調整可能。  
> - 入力中は「現在 x / 200 文字」のようなカウンタ表示を行う。

### 3.4 前週の研究報告時間（自動計算表示）

- 表示項目：  
  - 「前週の研究報告：**XX時間**」
- 計算方法：
  1. 前週 7 日分の「1日の大学滞在時間（分）」を全て合計 → `totalPrevMinutes`
  2. `totalPrevMinutes / 60` を **四捨五入して整数時間** にする → `totalPrevHoursRounded`
  3. 表示は `totalPrevHoursRounded` のみ（例：`14時間`）
- この値は PDF 上の当該欄に自動で出力する。

---

## 4. PDF 出力仕様

### 4.1 レイアウト全般

- 用紙サイズ：A4 横（landscape）。
- 1ページ（1枚）にすべての情報が収まるように調整する。
- テンプレート PDF（「研究室・週報（2025年度）」）と **同じ構造・同等の見た目** を目標とする。
  - タイトル
  - 上部の情報欄（氏名、提出日、時間など）
  - 左側：前週ブロック
  - 右側：今週ブロック
  - 表罫線・セル分割なども可能な範囲で再現する。

### 4.2 タイトル・ヘッダ部

- タイトル：  
  - `研究室・週報（[年度]年度）`  
  - 年度は画面の入力値を使用。
- 上部情報欄（例）：
  - 氏名
  - 提出日
  - 前週の研究報告：XX時間
  - その他、テンプレートに含まれる項目（必要に応じて）  
    ※ 指導教員名などが必要な場合は、将来的に入力項目を追加する。

### 4.3 前週ブロック（左）

- 見出し：`前週（YYYY/MM/DD〜YYYY/MM/DD）`
- 上部テキストエリア：
  - 前週の研究達成目標
  - 前週の目標達成度
  - ●達成点
  - ●課題・反省点
- 日ごとの表：
  - 行構造（例）：
    - 日付
    - 大学滞在時間（開始〜終了、離席時間等を含む表記）
    - 滞在時間（分）
    - 研究内容・行動・達成内容
  - 文字数制限およびフォントサイズ調整により、7日分が表内に収まるようにする。

### 4.4 今週ブロック（右）

- 見出し：`今週（YYYY/MM/DD〜YYYY/MM/DD）`
- 上部テキストエリア：
  - 今週の研究達成目標
  - 備考
- 日ごとの表：
  - 同様に
    - 日付
    - 大学滞在予定時間（開始〜終了・離席予定など）
    - 滞在予定時間（分）
    - 予定内容
  - PDFレイアウトは前週と左右対称となる。

### 4.5 フォント・レイアウト調整

- 基本フォントサイズは 9〜11pt 程度とする（A4 横1枚に収まるよう調整）。
- 入力文字が多い場合：
  - 原則として入力時点で文字数制限をかけることで溢れを防ぐ。
  - それでも収まりが悪い場合には、将来的にフォントサイズの自動縮小を検討する。

### 4.6 出力ファイル名

- 形式：  
  - `週報_[氏名]_[今週月曜日の日付].pdf`
- 日付形式：`YYYY-MM-DD`
- 氏名にスペースや記号が含まれる場合は、必要に応じて `_` に置換するなどの処理を行う。

---

## 5. 機能要件（まとめ）

1. 前週に含まれる任意の日付を入力すると、前週・今週の週範囲および各日付を自動計算して表示すること。
2. 氏名・年度・提出日などの基本情報を入力できること（氏名は必須）。
3. 前週・今週それぞれについて、7日分の
   - 滞在開始時刻
   - 滞在終了時刻
   - 離席時間（分）
   - 研究内容／行動／達成内容  
   を入力できること。
4. 各日について、滞在開始・終了・離席時間から **1日の大学滞在時間（分）** を自動計算し、表示すること。
5. 前週7日分の滞在時間（分）合計を求め、**時間に変換して四捨五入した整数時間** を「前週の研究報告：XX時間」として表示・PDFに出力すること。
6. 本文系テキスト（目標・達成度・達成点・課題・今週の目標・備考）を入力し、文字数制限内で PDF に出力すること。
7. テンプレートと同じレイアウトの PDF を A4 横 1 枚で生成すること。
8. ファイル名を指定形式（`週報_[氏名]_[今週月曜日の日付].pdf`）でダウンロードさせること。

---

## 6. 非機能要件・制約

- 対象ブラウザ：
  - 最新版の Chrome / Edge（PC）を主対象とする。
- タイムゾーン：
  - 基本は `Asia/Tokyo` を想定。
- 認証・保存：
  - ログイン機能は持たない。
  - サーバ側でのデータ永続化は行わない（リクエスト処理中のみデータを保持）。
- パフォーマンス：
  - 通常の週報1件の PDF 生成は数秒以内を目安とする。
- セキュリティ：
  - 入力データは PDF 生成後すぐに破棄し、ログなどに個人情報を残さない実装を基本方針とする。

---

## 7. 実装技術スタック・構成方針

- インフラ：
  - Vercel 上でホスト。
- フレームワーク：
  - Next.js（App Router）＋ TypeScript
- スタイリング：
  - Tailwind CSS（予定）
- PDF 生成：
  - Next.js の API Route または Server Action 上で `@react-pdf/renderer` を用いて PDF を生成する。
  - ランタイムは Node.js（Edge ではなく Node）を利用する。
- 外部連携：
  - 初期リリースでは Google Drive 等への自動アップロード機能は持たない。
  - 将来的な拡張で、Service Account 経由で研究室共有Driveへの自動保存を検討可能。

---

## 8. スコープ外／将来拡張候補

- △ 専用のユーザー管理・ログイン機能
- △ 作成済み週報の一覧表示・再ダウンロード機能
- △ Google Drive（または他クラウドストレージ）への自動アップロード機能
- △ 研究室ごとにフォーマットを切り替えられる機能
- △ スマホ向け UI 最適化（PC 利用を優先）

---

## 9. 今後の実装準備タスク（概要）

- Next.js プロジェクトの生成（TypeScript + Tailwind + App Router）。
- 型定義（`DayRecord`, `WeeklyReportPayload` など）の作成。
- 日付から前週・今週を算出するユーティリティ関数の実装。
- 時刻／離席時間から1日の滞在時間（分）を計算するユーティリティの実装。
- PDF コンポーネント（`WeeklyReportPdf`）の骨格実装。
- API Route（`/api/weekly-report`）で PDF を生成してレスポンスする処理の実装。
- フロントフォーム画面（`app/page.tsx`）での入力 UI と API 呼び出し・PDF ダウンロード処理の実装。

